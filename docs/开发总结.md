# 开发总结：PDF 拆分合并 Web 应用

## 项目目标与思路
- 以静态站点（SPA）实现浏览器端 PDF 拆分/合并，降低后端复杂度。
- 接入 Supabase 提供真实用户体系（注册/登录/角色/禁用）与处理记录。
- 管理端（admin）统一管理用户与操作记录；部署到 Netlify 并用 Functions 安全调用服务端密钥。

## 系统架构与组件
- 前端：Vite + React + Tailwind，路由 `/split`、`/merge`、`/login`、`/admin`；顶部横幅组件。
  - 顶部横幅：[TopBanner.tsx](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/src/components/TopBanner.tsx)
  - 路由与入口：[App.tsx](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/src/App.tsx)
- PDF 处理：`pdf-lib` + `pdfjs-dist` 在浏览器端完成拆分/合并与缩略图。
  - 工具方法：[pdfUtils.ts](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/src/utils/pdfUtils.ts)
- 访客试用限制：`localStorage` 计数，未登录最多 3 次。
  - 试用逻辑：[trial.ts](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/src/utils/trial.ts)
- 用户与会话：`AuthContext`、`UIContext`、`FileContext`。
  - 认证上下文：[AuthContext.tsx](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/src/contexts/AuthContext.tsx)
- Supabase 集成：
  - 客户端封装与业务接口：[supabase.ts](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/src/utils/supabase.ts)
  - 类型扩展（角色/禁用）：[types/index.ts](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/src/types/index.ts)
- 管理后台：用户列表、禁用/启用、删除、导出 CSV；处理记录列表。
  - 管理页：[Admin.tsx](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/src/pages/Admin.tsx)
- Netlify Functions（使用服务端密钥）：
  - 创建管理员：[create-admin.ts](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/netlify/functions/create-admin.ts)
  - 更新密码：[update-password.ts](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/netlify/functions/update-password.ts)
  - 列出用户（合并 `auth.users` 与 `profiles`）：[list-users.ts](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/netlify/functions/list-users.ts)
- 部署与路由：
  - Netlify 构建配置与环境固定：[netlify.toml](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/netlify.toml)
  - SPA 回退配置：[_redirects](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/public/_redirects)

## 数据库与权限（Supabase）
- 迁移与表：`profiles`、`processed_files`，开启 RLS。
  - 初始化迁移：[001_init.sql](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/supabase/migrations/001_init.sql)
  - 设定管理员（9003755@qq.com）：[002_admin_9003755.sql](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/supabase/migrations/002_admin_9003755.sql)
  - 备用提权（注册后提升）：[003_promote_admin_after_signup.sql](file:///d:/Ai编程学习/pdf文件轻松分拆及合并的软件/supabase/migrations/003_promote_admin_after_signup.sql)
- 权限策略：
  - 用户可读写自身 `profiles` 与 `processed_files`；管理员可全局读取与管理。
  - 存储桶 `pdf-files` 公开读、认证写。

## 实现过程与关键改动
- 页面与功能搭建（拆分/合并/登录/管理），完成本地构建与静态部署。
- 接入 Supabase：注册写入 `profiles`、登录读取 `role/disabled` 并校验禁用；处理成功写入 `processed_files`。
- 访客试用限制：在拆分/合并前检查剩余次数，成功后更新提示。
- 管理员功能：列表、禁用/启用、删除、导出 CSV；用户列表改用 Netlify Function 保证服务端密钥不暴露。
- 文案与校验：登录页提示“密码必须 6 位或以上”，提交前校验长度。

## 遇到的问题与解决
- 构建类型错误（`pdfjs` 渲染参数缺失）：补充 `page.render` 的 `canvas` 字段。
- 类型不匹配（`User` 缺少 `role/disabled`）：扩展类型并在上下文统一注入。
- 登录显示“用户不存在”：前端处于本地模式或未配置环境变量；在 Netlify 设置 `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY` 后重建。
- 普通用户注册后无法登录：默认开启邮箱验证；在 Authentication → Sign‑in providers → Email 关闭 “Confirm email”。
- 管理员看不到用户：`profiles` 未同步或 RLS 拦截；登录时自动补齐 `profiles`；列表改为服务端函数 `list-users` 合并 `auth.users` 与 `profiles`。
- 密码长度限制：Supabase 最少 6 位；前端增加文案与校验。

## 部署与配置要点
- 环境变量：
  - 前端：`VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`
  - 函数：`SUPABASE_SERVICE_ROLE_KEY`（仅服务端使用）
- 构建与发布：GitHub `main` 自动触发 Netlify 构建；必要时使用 “Deploy project without cache”。
- 路由：`public/_redirects` 设为 `/* /index.html 200` 以启用 SPA 回退。

## 验证与测试
- 本地：`npm run dev` 与 `npm run build` 验证页面与类型。
- 端到端用例：
  - 访客 3 次限制→提示注册；登录后不受限。
  - 普通用户注册（≥6 位密码）→立即登录→记录写库。
  - 管理员登录 `/admin`：列表、禁用/启用、删除、导出。
- 函数接口：创建管理员、更新密码、列出用户均返回预期。

## 改进建议
- 代码分割与体积优化：动态加载 PDF 库、按需拆包，降低主包体积。
- 统一用户创建通道：新增 `create-user` 函数（角色 `user`，`email_confirm=true`），支持邀请与批量创建。
- 安全与审计：新增审计日志表记录管理员关键操作；危险动作二次确认与原因。
- RLS 精细化：为 `processed_files` 增强“管理员可见全部 + 用户可见自身”的组合策略；存储按用户前缀隔离。
- 体验提升：登录支持魔法链接/忘记密码；后台列表支持搜索、分页与筛选。
- 工程化与测试：引入 GitHub Actions 做类型检查/构建预验；补充单元测试与 e2e 测试。
- 性能与稳定：大文件处理用 Web Worker 分流；缩略图懒加载、移动端适配。

## 版本与提交索引（节选）
- `feat(netlify-fn): add create-admin server function (Supabase admin API)`
- `feat(netlify-fn): add update-password function using profiles lookup`
- `feat(admin): fetch users via Netlify function (service role) with supabase fallback`
- `fix(auth): auto-create profiles row on first login if missing`
- `feat(auth): add password length hint and validation on signup`

---
本文档用于记录本次开发的架构与实施细节、问题解决与优化方向，便于后续迭代与团队协作参考。

